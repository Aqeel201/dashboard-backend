<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>MediApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/assets/favicon_io/favicon.ico">
  <!-- AdminLTE CSS via CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <!-- Custom CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Professional Admin Design */
    :root {
      --primary-color: #3f51b5;
      --secondary-color: #1e293b;
      --accent-color: #10b981;
      --sidebar-width: 230px;
      --transition-speed: 0.3s;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f4f6f9;
      margin: 0;
      padding: 0;
    }

    /* Fixed Pins: Top and Left */
    .main-header.navbar {
      background: #ffffff !important;
      border-bottom: 1px solid #dee2e6;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      position: fixed;
      top: 0;
      left: var(--sidebar-width);
      right: 0;
      z-index: 1030;
      height: 57px;
      transition: left var(--transition-speed) ease-in-out;
      margin: 0 !important;
    }

    .sidebar-collapse .main-header.navbar {
      left: 4.6rem;
    }

    .navbar-nav .nav-link {
      color: #4b5563 !important;
      font-weight: 500;
    }

    /* Fixed Sidebar */
    .main-sidebar {
      background: var(--secondary-color) !important;
      width: var(--sidebar-width) !important;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1038;
      transition: width var(--transition-speed) ease-in-out;
    }

    .sidebar {
      height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 10px 5px 80px 5px;
    }

    /* Zero Gap Content Wrapper */
    .content-wrapper {
      background-color: #f4f6f9 !important;
      margin-left: var(--sidebar-width) !important;
      margin-top: 57px !important;
      min-height: calc(100vh - 57px) !important;
      padding: 0 !important;
      transition: margin-left var(--transition-speed) ease-in-out;
    }

    .sidebar-collapse .content-wrapper {
      margin-left: 4.6rem !important;
    }

    /* Standard Footer */
    .main-footer {
      background: #ffffff;
      border-top: 1px solid #dee2e6;
      padding: 15px 25px;
      color: #6c757d;
      margin-left: var(--sidebar-width);
      transition: margin-left var(--transition-speed) ease-in-out;
      z-index: 1020;
    }

    .sidebar-collapse .main-footer {
      margin-left: 4.6rem;
    }

    /* Modern active states */
    .nav-pills .nav-link {
      color: #cbd5e1 !important;
      border-radius: 4px;
      margin: 2px 0;
      transition: all 0.2s;
    }

    .nav-pills .nav-link:hover {
      background: rgba(255, 255, 255, 0.05);
      color: #fff !important;
    }

    .nav-pills .nav-link.active {
      background-color: var(--primary-color) !important;
      color: #fff !important;
    }

    .sidebar::-webkit-scrollbar {
      width: 4px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }

    .brand-link {
      background-color: rgba(0, 0, 0, 0.1);
      text-align: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
    }

    .user-panel {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      padding: 15px;
      text-align: center;
    }

    /* General Fixes */
    .container-fluid {
      padding: 30px 15px;
    }
  </style>
</head>

<body class="hold-transition sidebar-mini layout-fixed <%= settings.darkMode ? 'dark-mode' : '' %>">
  <div class="wrapper">
    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-dark">
      <ul class="navbar-nav">

        <li class="nav-item d-none d-sm-inline-block">
          <% let screenName="Dashboard" ; if (typeof currentPath !=='undefined' ) { if (currentPath==='/admin/dashboard'
            ) screenName="Dashboard" ; else if (currentPath.includes('/admin/medicines') ||
            currentPath==='/admin/add-medicine' || currentPath==='/admin/edit-medicines' )
            screenName="Medicines Management" ; else if (currentPath==='/admin/orders' ) screenName="Orders" ; else if
            (currentPath==='/admin/inperson-sales' ) screenName="In-Person Sales" ; else if
            (currentPath==='/admin/transactions' ) screenName="Transactions" ; else if
            (currentPath==='/admin/purchase-history' ) screenName="Purchase History" ; else if
            (currentPath==='/admin/users' ) screenName="User" ; else if (currentPath==='/admin/settings' )
            screenName="Settings" ; else if (currentPath==='/admin/feedback' ) screenName="User Feedback" ; else if
            (currentPath==='/admin/chat' ) screenName="Chat" ; } %>
            <a href="<%= typeof currentPath !== 'undefined' && currentPath ? currentPath + '?token=' + token : '/admin/dashboard?token=' + token %>"
              class="nav-link">
              <%= screenName %>
            </a>
        </li>
      </ul>
      <!-- Right navbar -->
      <ul class="navbar-nav ml-auto">
        <!-- Live Time Display -->
        <li class="nav-item">
          <a class="nav-link" href="#"><i class="far fa-clock"></i> <span id="liveTime"></span></a>
        </li>
        <!-- Fullscreen -->
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" href="#" role="button">
            <i class="fas fa-expand-arrows-alt"></i>
          </a>
        </li>
        <% const expiryMedicinesArray=(typeof expiryMedicines !=='undefined' ) ? expiryMedicines : []; const
          lowStockMedicinesArray=(typeof lowStockMedicines !=='undefined' ) ? lowStockMedicines : []; const
          pendingOrdersArray=(typeof pendingOrders !=='undefined' ) ? pendingOrders : []; const
          expiryCount=expiryMedicinesArray.length; const lowStockCount=lowStockMedicinesArray.length; const
          pendingOrdersCount=pendingOrdersArray.length; const notificationCount=expiryCount + lowStockCount +
          pendingOrdersCount; %>
          <!-- Notifications Dropdown Menu -->
          <li class="nav-item dropdown">
            <a class="nav-link" data-toggle="dropdown" href="#">
              <i class="far fa-bell"></i>
              <span class="badge badge-warning navbar-badge" style="font-size: 0.75rem; padding: 0.2em 0.4em;">
                <%= notificationCount %>
              </span>
            </a>
            <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
              <span class="dropdown-item dropdown-header">
                <%= notificationCount %> Notifications
              </span>
              <div class="dropdown-divider"></div>
              <!-- Expiring Medicines Notifications -->
              <% if (expiryMedicinesArray.length> 0) { %>
                <% expiryMedicinesArray.forEach(function(medicine) { %>
                  <a href="/admin/medicines?token=<%= token %>" class="dropdown-item">
                    <i class="fas fa-exclamation-triangle mr-2 text-warning"></i>
                    <strong>
                      <%= medicine.name %>
                    </strong> expiring on <%= new Date(medicine.expiryDate).toLocaleDateString() %>
                      <span class="float-right text-muted text-sm">Soon</span>
                  </a>
                  <div class="dropdown-divider"></div>
                  <% }); %>
                    <% } %>
                      <!-- Low Stock Medicines Notifications -->
                      <% if (lowStockMedicinesArray.length> 0) { %>
                        <% lowStockMedicinesArray.forEach(function(medicine) { %>
                          <a href="/admin/medicines?token=<%= token %>" class="dropdown-item">
                            <i class="fas fa-exclamation-triangle mr-2 text-danger"></i>
                            <strong>
                              <%= medicine.name %>
                            </strong> low in stock (<%= medicine.quantity %>)
                              <span class="float-right text-muted text-sm">Low Stock</span>
                          </a>
                          <div class="dropdown-divider"></div>
                          <% }); %>
                            <% } %>
                              <!-- Pending Orders Notifications -->
                              <% if (pendingOrdersArray.length> 0) { %>
                                <% pendingOrdersArray.forEach(function(order) { %>
                                  <a href="/admin/orders?token=<%= token %>" class="dropdown-item">
                                    <i class="fas fa-hourglass-half mr-2 text-info"></i>
                                    Order #<%= order._id %> is pending.
                                      <span class="float-right text-muted text-sm">Pending</span>
                                  </a>
                                  <div class="dropdown-divider"></div>
                                  <% }); %>
                                    <% } %>
                                      <a href="/admin/medicines?token=<%= token %>"
                                        class="dropdown-item dropdown-footer">See All Notifications</a>
            </div>
          </li>
          <!-- Dark Mode Toggle -->
          <li class="nav-item dark-mode-toggle">
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="darkModeToggle" <%=settings.darkMode ? 'checked'
                : '' %>>
              <label class="custom-control-label" for="darkModeToggle"><i class="fas fa-moon"></i></label>
            </div>
          </li>
          <!-- Logout -->
          <li class="nav-item">
            <a class="nav-link" href="#" id="logoutBtn">
              <i class="fas fa-sign-out-alt"></i> Logout
            </a>
          </li>
      </ul>
    </nav>

    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
      <!-- Brand Logo -->
      <a href="/admin/dashboard?token=<%= token %>" class="brand-link text-center">
        <img src="/assets/Logo.png" alt="MediApp Logo" class="brand-image img-circle elevation-3">
        <span class="brand-text font-weight-light" style="font-size: 1.4rem; letter-spacing: 1px;">MediApp</span>
      </a>
      <!-- User Panel -->
      <div class="user-panel">
        <div class="image">
          <% if (user && user.profileImage && user.profileImage.trim() !=='' ) { %>
            <img src="<%= user.profileImage %>" class="img-circle elevation-2" alt="User Profile Image">
            <% } else { %>
              <img src="/assets/default-profile.jpg" class="img-circle elevation-2" alt="Default Profile Image">
              <% } %>
        </div>
        <div class="info mt-2">
          <p class="mb-0 text-white" style="font-weight: 500;">
            <%= user ? `${user.firstName} ${user.lastName}` : 'Admin User' %>
          </p>
          <small class="text-muted">Administrator</small>
        </div>
      </div>
      <!-- Sidebar Menu -->
      <div class="sidebar">
        <nav class="mt-2">
          <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
            <!-- Dashboard -->
            <li class="nav-item">
              <a href="/admin/dashboard?token=<%= token %>"
                class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/dashboard' ? 'active' : '' %>">
                <i class="nav-icon fas fa-tachometer-alt"></i>
                <p>Dashboard</p>
              </a>
            </li>
            <!-- Medicines Management -->
            <li
              class="nav-item has-treeview <%= typeof currentPath !== 'undefined' && (currentPath.includes('/admin/medicines') || currentPath === '/admin/add-medicine' || currentPath === '/admin/edit-medicines') ? 'menu-open' : '' %>">
              <a href="#" class="nav-link">
                <i class="nav-icon fas fa-pills"></i>
                <p>
                  Medicines Management
                  <i class="right fas fa-angle-left"></i>
                </p>
              </a>
              <ul class="nav nav-treeview">
                <li class="nav-item">
                  <a href="/admin/medicines?token=<%= token %>"
                    class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/medicines' ? 'active' : '' %>">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Medicine Inventory</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="/admin/edit-medicines?token=<%= token %>"
                    class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/edit-medicines' ? 'active' : '' %>">
                    <i class="far fa-circle nav-icon"></i>
                    <p>Edit Medicines</p>
                  </a>
                </li>
                <li class="nav-item">
                  <a href="/admin/add-medicine?token=<%= token %>"
                    class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/add-medicine' ? 'active' : '' %>">
                    <i class="fas fa-plus-circle nav-icon"></i>
                    <p>Add New Medicine</p>
                  </a>
                </li>
              </ul>
            </li>
            <!-- Orders -->
            <li class="nav-item">
              <a href="/admin/orders?token=<%= token %>"
                class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/orders' ? 'active' : '' %>">
                <i class="nav-icon fas fa-shopping-cart"></i>
                <p>Orders</p>
              </a>
            </li>
            <!-- Manual Order Entry -->
            <li class="nav-item">
              <a href="/admin/inperson-sales?token=<%= token %>"
                class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/inperson-sales' ? 'active' : '' %>">
                <i class="nav-icon fas fa-edit"></i>
                <p>In-Person Sales</p>
              </a>
            </li>
            <!-- Transactions -->
            <li class="nav-item">
              <a href="/admin/transactions?token=<%= token %>"
                class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/transactions' ? 'active' : '' %>">
                <i class="nav-icon fas fa-exchange-alt"></i>
                <p>Transactions</p>
              </a>
            </li>
            <!-- Purchase History -->
            <li class="nav-item">
              <a href="/admin/purchase-history?token=<%= token %>"
                class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/purchase-history' ? 'active' : '' %>">
                <i class="nav-icon fas fa-history"></i>
                <p>Purchase History</p>
              </a>
            </li>
            <!-- Users Management -->
            <li class="nav-item">
              <a href="/admin/users?token=<%= token %>"
                class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/users' ? 'active' : '' %>">
                <i class="nav-icon fas fa-users"></i>
                <p>Users</p>
              </a>
            </li>
            <!-- Chat -->
            <li class="nav-item">
              <a href="/admin/chat?token=<%= token %>"
                class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/chat' ? 'active' : '' %>">
                <i class="nav-icon fas fa-comments"></i>
                <p>Chat</p>
              </a>
            </li>
            <!-- User Feedback -->
            <li class="nav-item">
              <a href="/admin/feedback?token=<%= token %>"
                class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/feedback' ? 'active' : '' %>">
                <i class="nav-icon fas fa-comment-alt"></i>
                <p>User Feedback</p>
              </a>
            </li>
            <!-- Settings -->
            <li class="nav-item">
              <a href="/admin/settings?token=<%= token %>"
                class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/settings' ? 'active' : '' %>">
                <i class="nav-icon fas fa-cogs"></i>
                <p>Settings</p>
              </a>
            </li>
            <!-- Logout (Sidebar) -->
            <li class="nav-item">
              <a href="#" class="nav-link" id="sidebarLogoutBtn">
                <i class="nav-icon fas fa-sign-out-alt"></i>
                <p>Logout</p>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </aside>
    <!-- Content Wrapper -->
    <div class="content-wrapper">