<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>MediApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/assets/favicon_io/favicon.ico">
  <!-- AdminLTE CSS via CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/custom.css">
  <style>
    /* Custom Styles */
    :root {
      --primary-color: #3f51b5;
      --secondary-color: #2c3e50;
      --accent-color: #4CAF50;
    }
    .brand-link {
      transition: all 0.3s ease;
      border-bottom: 2px solid rgba(255,255,255,0.1);
    }
    .brand-link img {
      width: 40px;
      height: 40px;
      margin-right: 10px;
      filter: drop-shadow(0 0 2px rgba(255,255,255,0.5));
    }
    .main-sidebar {
      background: var(--secondary-color) !important;
      transition: transform 0.3s ease-in-out;
    }
    .nav-item > .nav-link {
      transition: all 0.2s ease;
      border-radius: 5px;
      margin: 2px 10px;
      position: relative;
    }
    .nav-item > .nav-link:hover {
      transform: translateX(5px);
      background: rgba(255,255,255,0.05);
      border-left: 3px solid var(--accent-color);
    }
    .nav-item > .nav-link.active {
      background: linear-gradient(90deg, var(--primary-color), rgba(63,81,181,0.5));
      border-left: 3px solid var(--accent-color);
    }
    .navbar {
      background: linear-gradient(135deg, var(--primary-color), #2c387e);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .content-wrapper {
      background: #f8f9fa;
      animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .sidebar-dark-primary .nav-sidebar > .nav-item > .nav-link.active {
      background-color: rgba(255,255,255,0.1);
    }
    .user-panel {
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 15px;
      text-align: center;
    }
    .user-panel img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid var(--accent-color);
      box-shadow: 0 0 10px rgba(76,175,80,0.3);
      object-fit: cover;
    }
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.1);
    }
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 4px;
    }
    /* Dark Mode Toggle */
    .dark-mode-toggle {
      margin-left: 10px;
    }
    .dark-mode-toggle .custom-control-input:checked ~ .custom-control-label::before {
      background-color: #4CAF50;
      border-color: #4CAF50;
    }
  </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed <%= settings.darkMode ? 'dark-mode' : '' %>">
<div class="wrapper">
  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-dark">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button">
          <i class="fas fa-bars"></i>
        </a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <% 
          // Determine the screen name based on currentPath with fallback
          let screenName = "Dashboard"; // Default name
          if (typeof currentPath !== 'undefined') {
            if (currentPath === '/admin/dashboard') screenName = "Dashboard";
            else if (currentPath.includes('/admin/medicines') || currentPath === '/admin/add-medicine' || currentPath === '/admin/edit-medicines') screenName = "Medicines Management";
            else if (currentPath === '/admin/orders') screenName = "Orders";
            else if (currentPath === '/admin/inperson-sales') screenName = "In-Person Sales";
            else if (currentPath === '/admin/transactions') screenName = "Transactions";
            else if (currentPath === '/admin/purchase-history') screenName = "Purchase History";
            else if (currentPath === '/admin/users') screenName = "User";
            else if (currentPath === '/admin/settings') screenName = "Settings";
            else if (currentPath === '/admin/feedback') screenName = "User Feedback"; // Added User Feedback
            else if (currentPath === '/admin/chat') screenName = "Chat"; // Added Chat


          }
        %>
        <a href="<%= typeof currentPath !== 'undefined' && currentPath ? currentPath + '?token=' + token : '/admin/dashboard?token=' + token %>" class="nav-link"><%= screenName %></a>
      </li>
    </ul>
    <!-- Right navbar -->
    <ul class="navbar-nav ml-auto">
      <!-- Live Time Display -->
      <li class="nav-item">
        <a class="nav-link" href="#"><i class="far fa-clock"></i> <span id="liveTime"></span></a>
      </li>    
      <!-- Fullscreen -->
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button">
          <i class="fas fa-expand-arrows-alt"></i>
        </a>
      </li>
      <% 
        // Use empty arrays as defaults if the notifications variables are not defined
        const expiryMedicinesArray = (typeof expiryMedicines !== 'undefined') ? expiryMedicines : [];
        const lowStockMedicinesArray = (typeof lowStockMedicines !== 'undefined') ? lowStockMedicines : [];
        const pendingOrdersArray = (typeof pendingOrders !== 'undefined') ? pendingOrders : [];
        const expiryCount = expiryMedicinesArray.length;
        const lowStockCount = lowStockMedicinesArray.length;
        const pendingOrdersCount = pendingOrdersArray.length;
        const notificationCount = expiryCount + lowStockCount + pendingOrdersCount;
      %>
      <!-- Notifications Dropdown Menu -->
      <li class="nav-item dropdown">
        <a class="nav-link" data-toggle="dropdown" href="#">
          <i class="far fa-bell"></i>
          <span class="badge badge-warning navbar-badge" style="font-size: 0.75rem; padding: 0.2em 0.4em;"><%= notificationCount %></span>
        </a>
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
          <span class="dropdown-item dropdown-header"><%= notificationCount %> Notifications</span>
          <div class="dropdown-divider"></div>
          <!-- Expiring Medicines Notifications -->
          <% if (expiryMedicinesArray.length > 0) { %>
            <% expiryMedicinesArray.forEach(function(medicine) { %>
              <a href="/admin/medicines?token=<%= token %>" class="dropdown-item">
                <i class="fas fa-exclamation-triangle mr-2 text-warning"></i>
                <strong><%= medicine.name %></strong> expiring on 
                <%= new Date(medicine.expiryDate).toLocaleDateString() %>
                <span class="float-right text-muted text-sm">Soon</span>
              </a>
              <div class="dropdown-divider"></div>
            <% }); %>
          <% } %>
          <!-- Low Stock Medicines Notifications -->
          <% if (lowStockMedicinesArray.length > 0) { %>
            <% lowStockMedicinesArray.forEach(function(medicine) { %>
              <a href="/admin/medicines?token=<%= token %>" class="dropdown-item">
                <i class="fas fa-exclamation-triangle mr-2 text-danger"></i>
                <strong><%= medicine.name %></strong> low in stock (<%= medicine.quantity %>)
                <span class="float-right text-muted text-sm">Low Stock</span>
              </a>
              <div class="dropdown-divider"></div>
            <% }); %>
          <% } %>
          <!-- Pending Orders Notifications -->
          <% if (pendingOrdersArray.length > 0) { %>
            <% pendingOrdersArray.forEach(function(order) { %>
              <a href="/admin/orders?token=<%= token %>" class="dropdown-item">
                <i class="fas fa-hourglass-half mr-2 text-info"></i>
                Order #<%= order._id %> is pending.
                <span class="float-right text-muted text-sm">Pending</span>
              </a>
              <div class="dropdown-divider"></div>
            <% }); %>
          <% } %>
          <a href="/admin/medicines?token=<%= token %>" class="dropdown-item dropdown-footer">See All Notifications</a>
        </div>
      </li>
      <!-- Dark Mode Toggle -->
      <li class="nav-item dark-mode-toggle">
        <div class="custom-control custom-switch">
          <input type="checkbox" class="custom-control-input" id="darkModeToggle" <%= settings.darkMode ? 'checked' : '' %>>
          <label class="custom-control-label" for="darkModeToggle"><i class="fas fa-moon"></i></label>
        </div>
      </li>
      <!-- Logout -->
      <li class="nav-item">
        <a class="nav-link" href="#" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </li>
    </ul>
  </nav>
  
  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <!-- Brand Logo -->
    <a href="/admin/dashboard?token=<%= token %>" class="brand-link text-center">
      <img src="/assets/Logo.png" alt="MediApp Logo" class="brand-image img-circle elevation-3">
      <span class="brand-text font-weight-light" style="font-size: 1.4rem; letter-spacing: 1px;">MediApp</span>
    </a>
    <!-- User Panel -->
    <div class="user-panel">
      <div class="image">
        <% if (user && user.profileImage && user.profileImage.trim() !== '') { %>
          <img src="/uploads/Profile/<%= user.profileImage %>" class="img-circle elevation-2" alt="User Profile Image">
        <% } else { %>
          <img src="/assets/default-profile.jpg" class="img-circle elevation-2" alt="Default Profile Image">
        <% } %>
      </div>
      <div class="info mt-2">
        <p class="mb-0 text-white" style="font-weight: 500;">
          <%= user ? `${user.firstName} ${user.lastName}` : 'Admin User' %>
        </p>
        <small class="text-muted">Administrator</small>
      </div>
    </div>
    <!-- Sidebar Menu -->
    <div class="sidebar">
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
          <!-- Dashboard -->
          <li class="nav-item">
            <a href="/admin/dashboard?token=<%= token %>" class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/dashboard' ? 'active' : '' %>">
              <i class="nav-icon fas fa-tachometer-alt"></i>
              <p>Dashboard</p>
            </a>
          </li>
          <!-- Medicines Management -->
          <li class="nav-item has-treeview <%= typeof currentPath !== 'undefined' && (currentPath.includes('/admin/medicines') || currentPath === '/admin/add-medicine' || currentPath === '/admin/edit-medicines') ? 'menu-open' : '' %>">
            <a href="#" class="nav-link">
              <i class="nav-icon fas fa-pills"></i>
              <p>
                Medicines Management
                <i class="right fas fa-angle-left"></i>
              </p>
            </a>
            <ul class="nav nav-treeview">
              <li class="nav-item">
                <a href="/admin/medicines?token=<%= token %>" class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/medicines' ? 'active' : '' %>">
                  <i class="far fa-circle nav-icon"></i>
                  <p>Medicine Inventory</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="/admin/edit-medicines?token=<%= token %>" class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/edit-medicines' ? 'active' : '' %>">
                  <i class="far fa-circle nav-icon"></i>
                  <p>Edit Medicines</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="/admin/add-medicine?token=<%= token %>" class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/add-medicine' ? 'active' : '' %>">
                  <i class="fas fa-plus-circle nav-icon"></i>
                  <p>Add New Medicine</p>
                </a>
              </li>
            </ul>
          </li>
          <!-- Orders -->
          <li class="nav-item">
            <a href="/admin/orders?token=<%= token %>" class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/orders' ? 'active' : '' %>">
              <i class="nav-icon fas fa-shopping-cart"></i>
              <p>Orders</p>
            </a>
          </li>
          <!-- Manual Order Entry -->
          <li class="nav-item">
            <a href="/admin/inperson-sales?token=<%= token %>" class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/inperson-sales' ? 'active' : '' %>">
              <i class="nav-icon fas fa-edit"></i>
              <p>In-Person Sales</p>
            </a>
          </li>
          <!-- Transactions -->
          <li class="nav-item">
            <a href="/admin/transactions?token=<%= token %>" class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/transactions' ? 'active' : '' %>">
              <i class="nav-icon fas fa-exchange-alt"></i>
              <p>Transactions</p>
            </a>
          </li>
          <!-- Purchase History -->
          <li class="nav-item">
            <a href="/admin/purchase-history?token=<%= token %>" class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/purchase-history' ? 'active' : '' %>">
              <i class="nav-icon fas fa-history"></i>
              <p>Purchase History</p>
            </a>
          </li>
          <!-- Users Management -->
          <li class="nav-item">
            <a href="/admin/users?token=<%= token %>" class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/users' ? 'active' : '' %>">
              <i class="nav-icon fas fa-users"></i>
              <p>Users</p>
            </a>
          </li>
                    <!-- Chat -->
          <li class="nav-item">
            <a href="/admin/chat?token=<%= token %>" class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/chat' ? 'active' : '' %>">
              <i class="nav-icon fas fa-comments"></i>
              <p>Chat</p>
            </a>
          </li>
                    <!-- User Feedback -->
          <li class="nav-item">
            <a href="/admin/feedback?token=<%= token %>" class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/feedback' ? 'active' : '' %>">
              <i class="nav-icon fas fa-comment-alt"></i>
              <p>User Feedback</p>
            </a>
          </li>
          <!-- Settings -->
          <li class="nav-item">
            <a href="/admin/settings?token=<%= token %>" class="nav-link <%= typeof currentPath !== 'undefined' && currentPath === '/admin/settings' ? 'active' : '' %>">
              <i class="nav-icon fas fa-cogs"></i>
              <p>Settings</p>
            </a>
          </li>
          <!-- Logout (Sidebar) -->
          <li class="nav-item">
            <a href="#" class="nav-link" id="sidebarLogoutBtn">
              <i class="nav-icon fas fa-sign-out-alt"></i>
              <p>Logout</p>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </aside>
  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <!-- (View-specific content will be injected here) -->

  <!-- Scripts Moved to Footer -->
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- AdminLTE App -->
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
  <script>
    // Dark Mode Toggle Functionality
    const darkModeToggle = document.getElementById('darkModeToggle');
    darkModeToggle.addEventListener('change', function() {
      if (this.checked) {
        document.body.classList.add('dark-mode');
        localStorage.setItem('darkMode', 'enabled');
      } else {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('darkMode', 'disabled');
      }
    });

    // Set initial state based on localStorage or settings
    const savedDarkMode = localStorage.getItem('darkMode');
    if (savedDarkMode === 'enabled' || (savedDarkMode === null && <%= settings.darkMode %>)) {
      document.body.classList.add('dark-mode');
      darkModeToggle.checked = true;
    }

    // Logout functionality: clear token from localStorage and redirect to login
    function performLogout() {
      localStorage.removeItem('token');
      window.location.href = '/login.html';
    }
    document.getElementById('logoutBtn')?.addEventListener('click', function(e) {
      e.preventDefault();
      performLogout();
    });
    document.getElementById('sidebarLogoutBtn')?.addEventListener('click', function(e) {
      e.preventDefault();
      performLogout();
    });

    // Live time function: updates the #liveTime element every second
    function updateClock() {
      const now = new Date();
      document.getElementById("liveTime").textContent = now.toLocaleTimeString();
    }
    setInterval(updateClock, 1000);
    updateClock();
  </script>
</body>
</html>