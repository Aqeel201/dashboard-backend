<%- include('partials/header') %>

<style>
  :root {
    --primary: #2c3e50; /* Deep Blue for Medical Store */
    --secondary: #3498db; /* Light Blue */
    --accent: #27ae60; /* Green for Success/Profit */
    --light: #ecf0f1; /* Light Gray Background */
    --dark: #2c3e50; /* Dark Blue Text */
    --success: #27ae60;
    --warning: #e67e22;
    --danger: #e74c3c;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    --border-radius: 8px;
  }

  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, var(--light), #d5d8dc);
    color: var(--dark);
    line-height: 1.6;
    margin: 0;
  }

  .dashboard-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
    background: #fff;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    border: 2px solid var(--primary);
    animation: slideIn 1s ease-in;
  }

  .dashboard-header {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: #fff;
    padding: 2.5rem;
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    text-align: center;
    margin-bottom: 2rem;
    animation: fadeIn 1s ease-in;
  }
  .dashboard-header h1 {
    font-size: 3rem;
    margin: 0;
    font-weight: 800;
    text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
  }
  .dashboard-header p {
    font-size: 1.1rem;
    opacity: 0.9;
    margin: 0.5rem 0 0;
    font-weight: 600;
  }

  .content-header {
    padding: 1.5rem 2rem;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid var(--primary);
  }
  .content-header h1 {
    font-size: 2rem;
    color: var(--primary);
    font-weight: 800;
  }
  .input-group {
    margin-right: 1rem;
  }
  .btn-group .btn {
    margin-right: 0.5rem;
  }
  .btn-outline-primary {
    border-color: var(--primary);
    color: var(--primary);
    transition: all 0.3s ease;
  }
  .btn-outline-primary:hover, .btn-outline-primary.active {
    background: var(--primary);
    color: #fff;
    border-color: var(--primary);
    transform: translateY(-2px);
  }

  .history-section, .report-section {
    background: #fff;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 2rem;
    margin-bottom: 2rem;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .history-section:hover, .report-section:hover {
    transform: translateY(-10px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  }
  .history-section h2, .report-section h2 {
    font-size: 2rem;
    color: var(--primary);
    margin-bottom: 1.5rem;
    border-bottom: 3px solid var(--primary);
    padding-bottom: 0.7rem;
    font-weight: 800;
  }

  .table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
  }
  .table th, .table td {
    padding: 1.2rem;
    text-align: left;
    border-bottom: 2px solid #e0e0e0;
    vertical-align: middle;
  }
  .table th {
    background: linear-gradient(135deg, var(--secondary), var(--primary));
    color: #fff;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .table tr {
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
  }
  .table tr:hover {
    background: #f5f7fa;
    transform: translateX(5px);
  }
  .price {
    font-weight: 700;
    color: var(--accent);
  }

  .report-tabs, .history-type-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }
  .report-tab, .history-tab {
    padding: 0.8rem 1.5rem;
    background: #e0e0e0;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: background 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
    font-weight: 700;
    color: var(--dark);
    border: 1px solid #d0d0d0;
  }
  .report-tab.active, .report-tab:hover, .history-tab.active, .history-tab:hover {
    background: var(--primary);
    color: #fff;
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    border-color: var(--primary);
  }

  .report-cards, .totals-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
  }
  .report-card, .total-card {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: #fff;
    border-radius: var(--border-radius);
    padding: 1.8rem;
    text-align: center;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: 2px solid rgba(255, 255, 255, 0.2);
  }
  .report-card:hover, .total-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  }
  .report-card h3, .total-card h3 {
    font-size: 1.8rem;
    margin-bottom: 0.7rem;
    font-weight: 800;
  }
  .report-card p, .total-card p {
    font-size: 1.5rem;
    margin: 0;
    font-weight: 700;
  }

  .print-btn {
    background: var(--success);
    color: #fff;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: background 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
    font-weight: 700;
    margin-top: 1.5rem;
    box-shadow: var(--shadow);
  }
  .print-btn:hover {
    background: #1e7e34;
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
  }

  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }
  .modal-content {
    background: #fff;
    border-radius: var(--border-radius);
    padding: 2.5rem;
    max-width: 700px;
    width: 90%;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    animation: slideDown 0.5s ease-in;
    border: 2px solid var(--primary);
  }
  .modal-content h3 {
    color: var(--primary);
    margin-bottom: 1.5rem;
    font-size: 2rem;
    font-weight: 800;
  }
  .modal-content .summary-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1.5rem;
  }
  .modal-content .summary-table th, .modal-content .summary-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 2px solid #e0e0e0;
  }
  .modal-content .summary-table th {
    background: var(--secondary);
    color: #fff;
    font-weight: 800;
  }
  .close-btn {
    background: var(--danger);
    color: #fff;
    border: none;
    padding: 0.7rem 1.2rem;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s ease, transform 0.3s ease;
    font-weight: 700;
  }
  .close-btn:hover {
    background: #c82333;
    transform: translateY(-2px);
  }

  .order-row { transition: all 0.3s ease; }
  .order-row:hover { transform: translateX(5px); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
  .status-indicator { width: 10px; height: 10px; border-radius: 50%; }
  .status-indicator.pending { background-color: #ffc107; }
  .status-indicator.accepted { background-color: #28a745; }
  .status-indicator.rejected { background-color: #dc3545; }
  .timeline { border-left: 2px solid #dee2e6; margin-left: 10px; padding-left: 20px; }
  .timeline li { margin-bottom: 1rem; position: relative; }
  .timeline li::before {
    content: ''; position: absolute; left: -25px; top: 4px; width: 12px; height: 12px; border-radius: 50%;
    background: #fff; border: 2px solid #007bff;
  }

  @media print {
    body.print-online .dashboard-container > *:not(.history-section),
    body.print-inperson .dashboard-container > *:not(.history-section) {
      display: none !important;
    }
    body.print-online #historyContent .history-section:not(:first-child),
    body.print-inperson #historyContent .history-section:not(:first-child) {
      display: none !important;
    }
    .history-type-tabs {
      display: none !important;
    }
    .modal {
      display: none !important;
    }
  }

  @media (max-width: 991px) {
    .dashboard-container {
      padding: 1.5rem;
    }
    .dashboard-header {
      padding: 2rem;
    }
    .dashboard-header h1 {
      font-size: 2.2rem;
    }
    .dashboard-header p {
      font-size: 0.9rem;
    }
    .history-section, .report-section {
      padding: 1.5rem;
    }
    .table th, .table td {
      padding: 0.7rem;
      font-size: 0.9rem;
    }
    .report-tabs, .history-type-tabs {
      flex-direction: column;
    }
    .report-tab, .history-tab {
      padding: 0.5rem 1rem;
    }
    .report-card, .total-card {
      padding: 1.2rem;
    }
    .modal-content {
      width: 95%;
    }
    .content-header h1 {
      font-size: 1.5rem;
    }
    .input-group {
      max-width: 200px;
    }
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<div class="dashboard-container">
  <!-- Dashboard Header -->
  <div class="dashboard-header">
    <h1>Medical Store Dashboard</h1>
    <p>Manage and track all online and in-person medicine purchases, sales, and profits</p>
  </div>

  <!-- Messages -->
  <% if (message) { %>
    <div class="alert alert-success" style="margin-bottom: 1.5rem;">
      <%= message %>
    </div>
  <% } %>
  <% if (error) { %>
    <div class="alert alert-danger" style="margin-bottom: 1.5rem;">
      <%= error %>
    </div>
  <% } %>

  <!-- Report Section with Tabs -->
  <div class="report-section">
    <h2>Sales & Profit Reports</h2>
    <div class="report-tabs">
      <div class="report-tab active" onclick="showReport('daily')">Daily</div>
      <div class="report-tab" onclick="showReport('weekly')">7 Days</div>
      <div class="report-tab" onclick="showReport('fortnightly')">15 Days</div>
      <div class="report-tab" onclick="showReport('monthly')">Monthly</div>
      <div class="report-tab" onclick="showReport('yearly')">Yearly</div>
    </div>
    <div class="report-cards" id="reportCards">
      <!-- Report cards will be dynamically updated via JavaScript -->
    </div>
    <!-- Total Sales and Profit -->
    <div class="totals-section">
      <div class="total-card">
        <h3>Total Sales (PKR)</h3>
        <p>Rs <%= totalSales %></p>
      </div>
      <div class="total-card">
        <h3>Total Profit (PKR)</h3>
        <p>Rs <%= totalProfit %></p>
      </div>
    </div>
    <!-- Print Button -->
    <button class="print-btn" onclick="window.print()">Print Dashboard</button>
  </div>

  <!-- History Type Selection -->
  <div class="history-section">
    <h2>Purchase History</h2>
    <div class="history-type-tabs">
      <div class="history-tab active" onclick="showHistory('online')">Online Orders</div>
      <div class="history-tab" onclick="showHistory('inperson')">In-Person Sales</div>
    </div>
    <div id="historyContent">
      <!-- History content will be dynamically updated via JavaScript -->
    </div>
  </div>

  <!-- Modal for Order/Sale Summary -->
  <div class="modal" id="summaryModal">
    <div class="modal-content">
      <h3>Order/Sale Details</h3>
      <table class="summary-table" id="summaryTable"></table>
      <button class="close-btn" onclick="closeSummary()">Close</button>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
// Function to set up event listeners for View Details buttons
function setupViewDetailsListeners() {
  const viewButtons = document.querySelectorAll('.view-btn');
  viewButtons.forEach(button => {
    const targetId = button.getAttribute('data-target');
    const targetCollapse = document.querySelector(targetId);
    const buttonText = button.querySelector('.btn-text');

    // Remove any existing event listeners to avoid duplicates
    button.removeEventListener('click', toggleCollapseHandler);
    targetCollapse.removeEventListener('show.bs.collapse', showCollapseHandler);
    targetCollapse.removeEventListener('hide.bs.collapse', hideCollapseHandler);

    // Add new event listeners
    targetCollapse.addEventListener('show.bs.collapse', showCollapseHandler);
    targetCollapse.addEventListener('hide.bs.collapse', hideCollapseHandler);
    button.addEventListener('click', toggleCollapseHandler);

    function showCollapseHandler() {
      buttonText.textContent = 'Close';
      button.setAttribute('aria-expanded', 'true');
    }

    function hideCollapseHandler() {
      buttonText.textContent = 'View Details';
      button.setAttribute('aria-expanded', 'false');
    }

    function toggleCollapseHandler(e) {
      e.stopPropagation();
      $(targetCollapse).collapse('toggle');
    }
  });

  const closeButtons = document.querySelectorAll('.close-btn');
  closeButtons.forEach(button => {
    button.removeEventListener('click', closeCollapseHandler);
    button.addEventListener('click', closeCollapseHandler);

    function closeCollapseHandler() {
      const targetId = button.getAttribute('data-target');
      const targetCollapse = document.querySelector(targetId);
      if (targetCollapse && targetCollapse.classList.contains('show')) {
        $(targetCollapse).collapse('hide');
      }
    }
  });
}

// Function to show report based on time period
function showReport(period) {
  const reportCards = document.getElementById('reportCards');
  const totals = {
    daily: { sales: <%= dailyTotals.sales %>, profit: <%= dailyTotals.profit %>, orders: <%= dailyTotals.orders %>, label: 'Daily' },
    weekly: { sales: <%= weeklyTotals.sales %>, profit: <%= weeklyTotals.profit %>, orders: <%= weeklyTotals.orders %>, label: '7 Days' },
    fortnightly: { sales: <%= fortnightlyTotals.sales %>, profit: <%= fortnightlyTotals.profit %>, orders: <%= fortnightlyTotals.orders %>, label: '15 Days' },
    monthly: { sales: <%= monthlyTotals.sales %>, profit: <%= monthlyTotals.profit %>, orders: <%= monthlyTotals.orders %>, label: 'Monthly' },
    yearly: { sales: <%= yearlyTotals.sales %>, profit: <%= yearlyTotals.profit %>, orders: <%= yearlyTotals.orders %>, label: 'Yearly' }
  }[period];

  reportCards.innerHTML = `
    <div class="report-card">
      <h3>Total Sales (PKR)</h3>
      <p>Rs ${totals.sales.toFixed(2)}</p>
    </div>
    <div class="report-card">
      <h3>Total Profit (PKR)</h3>
      <p>Rs ${totals.profit.toFixed(2)}</p>
    </div>
    <div class="report-card">
      <h3>Total Orders</h3>
      <p>${totals.orders}</p>
    </div>
  `;

  document.querySelectorAll('.report-tab').forEach(tab => tab.classList.remove('active'));
  document.querySelector(`.report-tab[onclick="showReport('${period}')"]`).classList.add('active');
}

// Function to print specific history section
function printHistorySection(type) {
  document.body.classList.remove('print-online', 'print-inperson');
  document.body.classList.add(`print-${type}`);
  window.print();
  document.body.classList.remove(`print-${type}`);
}

// Function to show history based on type
function showHistory(type) {
  const historyContent = document.getElementById('historyContent');
  document.querySelectorAll('.history-tab').forEach(tab => tab.classList.remove('active'));
  document.querySelector(`.history-tab[onclick="showHistory('${type}')"]`).classList.add('active');

  if (type === 'online') {
    historyContent.innerHTML = `
      <div class="history-section">
        <h2>Online Medicine Orders</h2>
        <% if (onlineOrders.length === 0) { %>
          <p class="text-muted">No online orders found.</p>
        <% } else { %>
          <div class="row mb-3">
            <div class="col-12">
              <button class="btn btn-success float-right print-btn" onclick="printHistorySection('online')">
                <i class="fas fa-print mr-2"></i>Print Online Orders
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover table-striped">
              <thead class="bg-light-blue">
                <tr>
                  <th>Date</th>
                  <th>Medicine Name</th>
                  <th>Quantity</th>
                  <th>Unit Price (PKR)</th>
                  <th>Total Price (PKR)</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <% onlineOrders.forEach(order => { %>
                  <% order.cartItems.forEach(item => { %>
                    <tr class="transition-transform">
                      <td><%= new Date(order.date).toLocaleString() %></td>
                      <td><%= item.name || 'Unknown Medicine' %></td>
                      <td><%= item.cartQuantity || 0 %></td>
                      <td class="price">Rs <%= item.price ? item.price.toFixed(2) : '0.00' %></td>
                      <td class="price">Rs <%= item.price && item.cartQuantity ? (item.price * item.cartQuantity).toFixed(2) : '0.00' %></td>
                      <td class="align-middle text-center">
                        <button class="btn btn-primary btn-sm view-btn" 
                                data-toggle="collapse" 
                                data-target="#orderDetails-<%= order._id %>-<%= item._id %>" 
                                aria-expanded="false" 
                                aria-controls="orderDetails-<%= order._id %>-<%= item._id %>"
                                onclick="event.stopPropagation()">
                          <i class="fas fa-eye"></i> <span class="btn-text">View Details</span>
                        </button>
                      </td>
                    </tr>
                    <tr class="collapse" id="orderDetails-<%= order._id %>-<%= item._id %>">
                      <td colspan="6">
                        <div class="p-3 bg-light rounded shadow-sm">
                          <h6 class="text-primary mb-2">Order Details:</h6>
                          <ul class="list-unstyled">
                            <li><strong>Medicine:</strong> <%= item.name || 'Unknown Medicine' %></li>
                            <li><strong>Quantity:</strong> <%= item.cartQuantity || 0 %></li>
                            <li><strong>Unit Price:</strong> Rs <%= item.price ? item.price.toFixed(2) : '0.00' %></li>
                            <li><strong>Total Price:</strong> Rs <%= item.price && item.cartQuantity ? (item.price * item.cartQuantity).toFixed(2) : '0.00' %></li>
                            <li><strong>Date:</strong> <%= new Date(order.date).toLocaleString() %></li>
                            <li><strong>Customer:</strong> <%= order.shippingAddress.firstName %> <%= order.shippingAddress.lastName %></li>
                          </ul>
                          <button class="btn btn-sm btn-secondary mt-2 close-btn" 
                                  data-toggle="collapse" 
                                  data-target="#orderDetails-<%= order._id %>-<%= item._id %>" 
                                  aria-expanded="true" 
                                  aria-controls="orderDetails-<%= order._id %>-<%= item._id %>">
                            <i class="fas fa-times"></i> Close
                          </button>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>
    `;
  } else {
    historyContent.innerHTML = `
      <div class="history-section">
        <h2>In-Person Medicine Sales</h2>
        <% if (inPersonSales.length === 0) { %>
          <p class="text-muted">No in-person sales found.</p>
        <% } else { %>
          <div class="row mb-3">
            <div class="col-12">
              <button class="btn btn-success float-right print-btn" onclick="printHistorySection('inperson')">
                <i class="fas fa-print mr-2"></i>Print In-Person Sales
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover table-striped">
              <thead class="bg-light-blue">
                <tr>
                  <th>Date</th>
                  <th>Medicine Name</th>
                  <th>Type</th>
                  <th>Quantity</th>
                  <th>Unit</th>
                  <th>Unit Price (PKR)</th>
                  <th>Total Price (PKR)</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <% inPersonSales.forEach(sale => { %>
                  <tr class="transition-transform">
                    <td><%= new Date(sale.saleDate).toLocaleString() %></td>
                    <td><%= sale.medicineId && sale.medicineId.name ? sale.medicineId.name : sale.medicineName || 'Unknown Medicine' %></td>
                    <td><%= sale.medicineId && sale.medicineId.medicineType ? sale.medicineId.medicineType : 'N/A' %></td>
                    <td><%= sale.quantitySold || 0 %></td>
                    <td><%= sale.unitType === 'Bottle' ? 'Bottle' : sale.unitType === 'Full' ? 'Full ' + (sale.medicineId && sale.medicineId.medicineType ? sale.medicineId.medicineType : 'N/A') : 'Dose' %></td>
                    <td class="price">Rs <%= sale.medicineId && typeof sale.medicineId.price === 'number' ? (sale.unitType === 'Dose' && sale.medicineId.dosesPerUnit ? (sale.medicineId.price / sale.medicineId.dosesPerUnit) : sale.medicineId.price).toFixed(2) : '0.00' %></td>
                    <td class="price">Rs <%= typeof sale.totalAmount === 'number' ? sale.totalAmount.toFixed(2) : '0.00' %></td>
                    <td class="align-middle text-center">
                      <button class="btn btn-primary btn-sm view-btn" 
                              data-toggle="collapse" 
                              data-target="#saleDetails-<%= sale._id %>" 
                              aria-expanded="false" 
                              aria-controls="saleDetails-<%= sale._id %>"
                              onclick="event.stopPropagation()">
                        <i class="fas fa-eye"></i> <span class="btn-text">View Details</span>
                      </button>
                    </td>
                  </tr>
                  <tr class="collapse" id="saleDetails-<%= sale._id %>">
                    <td colspan="8">
                      <div class="p-3 bg-light rounded shadow-sm">
                        <h6 class="text-primary mb-2">Sale Details:</h6>
                        <ul class="list-unstyled">
                          <li><strong>Medicine:</strong> <%= sale.medicineId && sale.medicineId.name ? sale.medicineId.name : sale.medicineName || 'Unknown Medicine' %></li>
                          <li><strong>Type:</strong> <%= sale.medicineId && sale.medicineId.medicineType ? sale.medicineId.medicineType : 'N/A' %></li>
                          <li><strong>Quantity:</strong> <%= sale.quantitySold || 0 %></li>
                          <li><strong>Unit:</strong> <%= sale.unitType === 'Bottle' ? 'Bottle' : sale.unitType === 'Full' ? 'Full ' + (sale.medicineId && sale.medicineId.medicineType ? sale.medicineId.medicineType : 'N/A') : 'Dose' %></li>
                          <li><strong>Unit Price:</strong> Rs <%= sale.medicineId && typeof sale.medicineId.price === 'number' ? (sale.unitType === 'Dose' && sale.medicineId.dosesPerUnit ? (sale.medicineId.price / sale.medicineId.dosesPerUnit) : sale.medicineId.price).toFixed(2) : '0.00' %></li>
                          <li><strong>Total Price:</strong> Rs <%= typeof sale.totalAmount === 'number' ? sale.totalAmount.toFixed(2) : '0.00' %></li>
                          <li><strong>Date:</strong> <%= new Date(sale.saleDate).toLocaleString() %></li>
                        </ul>
                        <button class="btn btn-sm btn-secondary mt-2 close-btn" 
                                data-toggle="collapse" 
                                data-target="#saleDetails-<%= sale._id %>" 
                                aria-expanded="true" 
                                aria-controls="saleDetails-<%= sale._id %>">
                          <i class="fas fa-times"></i> Close
                        </button>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% } %>
      </div>
    `;
  }

  // Reattach event listeners after content is updated
  setupViewDetailsListeners();
}

// Function to show order summary in modal
function showOrderSummary(orderStr) {
  const order = JSON.parse(orderStr);
  let html = `
    <tr>
      <th>Item</th>
      <th>Quantity</th>
      <th>Unit Price (PKR)</th>
      <th>Total Price (PKR)</th>
    </tr>
  `;
  order.cartItems.forEach(item => {
    html += `
      <tr>
        <td>${item.name || 'Unknown Medicine'}</td>
        <td>${item.cartQuantity || 0}</td>
        <td class="price">Rs ${item.price ? item.price.toFixed(2) : '0.00'}</td>
        <td class="price">Rs ${item.price && item.cartQuantity ? (item.price * item.cartQuantity).toFixed(2) : '0.00'}</td>
      </tr>
    `;
  });
  html += `
    <tr>
      <td colspan="3" style="text-align: right; font-weight: 800;">Order Total:</td>
      <td class="price">Rs ${order.orderTotal ? order.orderTotal.toFixed(2) : '0.00'}</td>
    </tr>
  `;
  document.getElementById('summaryTable').innerHTML = html;
  document.getElementById('summaryModal').style.display = 'flex';
}

// Function to show in-person sale summary in modal
function showSaleSummary(saleStr) {
  const sale = JSON.parse(saleStr);
  let html = `
    <tr>
      <th>Medicine</th>
      <th>Type</th>
      <th>Quantity</th>
      <th>Unit</th>
      <th>Unit Price (PKR)</th>
      <th>Total Price (PKR)</th>
    </tr>
    <tr>
      <td>${sale.medicineId && sale.medicineId.name ? sale.medicineId.name : sale.medicineName || 'Unknown Medicine'}</td>
      <td>${sale.medicineId && sale.medicineId.medicineType ? sale.medicineId.medicineType : 'N/A'}</td>
      <td>${sale.quantitySold || 0}</td>
      <td>${sale.unitType === 'Bottle' ? 'Bottle' : sale.unitType === 'Full' ? 'Full ' + (sale.medicineId && sale.medicineId.medicineType ? sale.medicineId.medicineType : 'N/A') : 'Dose'}</td>
      <td class="price">Rs ${sale.medicineId && typeof sale.medicineId.price === 'number' ? (sale.unitType === 'Dose' && sale.medicineId.dosesPerUnit ? (sale.medicineId.price / sale.medicineId.dosesPerUnit) : sale.medicineId.price).toFixed(2) : '0.00'}</td>
      <td class="price">Rs ${typeof sale.totalAmount === 'number' ? sale.totalAmount.toFixed(2) : '0.00'}</td>
    </tr>
    <tr>
      <td colspan="5" style="text-align: right; font-weight: 800;">Sale Total:</td>
      <td class="price">Rs ${typeof sale.totalAmount === 'number' ? sale.totalAmount.toFixed(2) : '0.00'}</td>
    </tr>
  `;
  document.getElementById('summaryTable').innerHTML = html;
  document.getElementById('summaryModal').style.display = 'flex';
}

// Function to close modal
function closeSummary() {
  document.getElementById('summaryModal').style.display = 'none';
}

// JavaScript for Dashboard
document.addEventListener('DOMContentLoaded', () => {
  if (typeof $ === 'undefined') {
    console.error('jQuery is required for tooltips and modals.');
  } else {
    $('[data-toggle="tooltip"]').tooltip();
  }

  showHistory('online'); // Initialize with online orders

  window.onload = () => showReport('daily');
});
</script>

<%- include('partials/footer') %>